---
title: "Density"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Density}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  out.width = "90%"
)
library(tidyverse)
library(sf)
library(vpstheme)
library(rvest)
```

```{r setup}
library(vcglR)
```

```{r get_pop, include = FALSE, echo = FALSE}

population =
  "https://www.abs.gov.au/statistics/people/population/regional-population/latest-release" |> 
  read_html() |> 
  html_elements('div [href$=xlsx]') |>
  html_attr("href")  |>
  as_tibble_col("url") |>
  mutate(
    url = str_c("https://www.abs.gov.au", url)
  ) |>
  filter(str_detect(url,"32180DS0003")) |>
  rowwise() |>
  mutate(
    download = tempfile(fileext = ".xlsx")) |>
  ungroup()  |>
  mutate(
    x =
      pmap(
        list(url,download),
        function(a,b) if(!file.exists(b)) download.file(a,b, mode = "wb")))  |>
  select(-x) |>
  mutate(sheets = map(download,readxl::excel_sheets)) |>
  unnest(sheets) |>
  filter(str_detect(sheets,"Table 2")) |>
  # Extract data
  mutate(data=pmap(list(download,sheets), readxl::read_excel, skip=5))  |>
  select(data) |>
  unnest(data) |> 
  rename(
    "state_code" = 1,
    "state_name" = 2,
    "sa3_code" = 7,
    "sa3_name" = 8
  ) |> 
  filter(state_code == 2) |> 
  select(contains("sa3"),contains("20")) |> 
  pivot_longer(contains("20"), values_to = "population") |>
  mutate(population = as.numeric(population),
         fy_date = str_c(name,"-6-30") |> ymd())

venue_data = vcglR::egm_venue_data  |> 
  mutate(is_trial = str_detect(lga_name, "Monash|Dandenong|Ballarat"))

```


# Introduction

The number of gaming machines relative to population in a given geographic area is strongly correlated with expenditure on gaming machine play. This correlation holds across State, local government area and statistical area geographies in most research.[^1]

```{r join_population, echo = FALSE}

sa3_shape =
  strayr::read_absmap("sa32021", remove_year_suffix = TRUE) |> 
  filter(state_code == 2)


venue_crs = 
  venue_data |> 
  st_as_sf(
    coords = c("long", "lat"),
    crs = st_crs(sa3_shape))

venue_sa3 = 
  st_join(
    venue_crs,
    sa3_shape
  ) |> 
  as_tibble() |> 
  left_join(
    venue_data, 
    by = 
      join_by(venue_name, lga_name, venue_type,
              measure_type, value, fy_date, financial_year, is_trial)
    ) |> 
  select(
    contains("venue"),
    fy_date,
    is_trial,
    lat,
    long,
    measure_type, 
    value,
    contains("sa3"),
    ) |> 
  group_by(sa3_name) |> 
  mutate(sa3_trial = any(is_trial))


sa3_shape =
  left_join(
    sa3_shape,
    venue_sa3 |>
      filter(fy_date == max(fy_date)) |> 
      select(contains("sa3")),
    by = join_by(sa3_code, sa3_name)
  ) |> 
  mutate(sa3_trial = coalesce(sa3_trial,FALSE))

```


This correlation can be seen in Figure 1 below, which shows gaming machine density and net gambling expenditure per person at the statistical area (SA3) level in Victoria. 

```{r use_pop, echo = FALSE}
sa3_values_pop = 
  venue_sa3 |> 
  left_join(population, by = join_by(fy_date, sa3_code, sa3_name)) |> 
  group_by(fy_date, sa3_name, measure_type, sa3_trial) |> 
  summarise(
    population = first(population),
    value = sum(value),
    .groups = "drop") |> 
  mutate(
    per_1k = 1e3*value/population
  )

sa3_values_plot_data =
  sa3_values_pop |> 
  ungroup() |> 
  filter(!is.na(population)) |> 
  filter(fy_date %in% c(max(fy_date))) |>
  select(fy_date, sa3_name, measure_type, per_1k, sa3_trial) |> 
  pivot_wider(values_from = per_1k, names_from = measure_type)


ggplot() +
ggrepel::geom_text_repel(
  sa3_values_plot_data |> 
    filter(str_detect(sa3_name, "Ballarat|Monash|Dandenong")),
    colour = bv.charcoal,
    ylim = c(.9e6,1e6),
    direction = "x",
    size = 5,
    segment.color = bv.smoke,
  mapping =  aes(
    x = EGM,
    y = Expenditure,
    colour = sa3_trial,
    label = sa3_name))+
geom_point(
  sa3_values_plot_data,
  mapping = 
    aes(
      x = EGM,
      y = Expenditure,
      colour = sa3_trial,
      group = sa3_name)
  ) +
  ggplot2::coord_cartesian(xlim = c(0, 11), ylim = c(0, 1e6)) +
  scale_x_continuvps(
    name = "Gaming machines per 1000 people",
    breaks = seq(0,10,by=2)
  ) +
  scale_y_continuvps(
    name = "Net gambling expenditure\nper 1000 people, $ 000s",  ,
    labels = scales:::label_number(scale = 1/1e3)) +
  scale_color_manual(guide = "none", values = c(bv.purple, bv.navy)) +
  theme_vps_djcs() +
  labs(title = 
         str_c(
           "Gaming machines and net gambling ",
           "expenditure in Victoria at the SA3 level"))

``` 
```{r trial_lines, echo = FALSE}
trial_lines_data =
  sa3_values_pop |> 
  ungroup() |> 
  filter(!is.na(population)) |> 
  mutate(other_trial = 
           str_detect(
             sa3_name, 
             str_flatten(
               c("Essendon","Brunswick","Kingston"),
               collapse = "|"))) |> 
  filter(other_trial) |>
  select(fy_date, sa3_name, measure_type, per_1k, sa3_trial) |> 
  pivot_wider(values_from = per_1k, names_from = measure_type)

ggplot() +
  geom_path(
   trial_lines_data,
   mapping = 
     aes(
        x = EGM,
        y = Expenditure,
        colour = sa3_trial,
        group = sa3_name)
   ) +
  ggplot2::coord_cartesian(xlim = c(0, 11), ylim = c(0, 1e6)) +
  scale_x_continuvps(
    name = "Gaming machines per 1000 people",
    breaks = seq(0,10,by=2)
  ) +
  scale_y_continuvps(
    name = "Net gambling expenditure\nper 1000 people, $ 000s",  ,
    labels = scales:::label_number(scale = 1/1e3)) +
  scale_color_manual(guide = "none", values = c(bv.purple, bv.navy)) +
  theme_vps_djcs() +
  labs(title = 
         str_c(
           "Gaming machines and net gambling ",
           "expenditure overtime in select Victorian SA3s"))
```


[^1]: [Turning Point, 2015, Problem Gambling in Victoria: Identifying local area community and gaming industry risk and protective factors](https://responsiblegambling.vic.gov.au/documents/95/Research-report-pg-in-vic-community-industry-risk-protective-factors.pdf)
